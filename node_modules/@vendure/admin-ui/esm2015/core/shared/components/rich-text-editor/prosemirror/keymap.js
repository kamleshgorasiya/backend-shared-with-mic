import { chainCommands, exitCode, joinDown, joinUp, lift, selectParentNode, setBlockType, toggleMark, wrapIn, } from 'prosemirror-commands';
import { redo, undo } from 'prosemirror-history';
import { undoInputRule } from 'prosemirror-inputrules';
import { liftListItem, sinkListItem, splitListItem, wrapInList } from 'prosemirror-schema-list';
const mac = typeof navigator !== 'undefined' ? /Mac/.test(navigator.platform) : false;
// :: (Schema, ?Object) â†’ Object
// Inspect the given schema looking for marks and nodes from the
// basic schema, and if found, add key bindings related to them.
// This will add:
//
// * **Mod-b** for toggling [strong](#schema-basic.StrongMark)
// * **Mod-i** for toggling [emphasis](#schema-basic.EmMark)
// * **Mod-`** for toggling [code font](#schema-basic.CodeMark)
// * **Ctrl-Shift-0** for making the current textblock a paragraph
// * **Ctrl-Shift-1** to **Ctrl-Shift-Digit6** for making the current
//   textblock a heading of the corresponding level
// * **Ctrl-Shift-Backslash** to make the current textblock a code block
// * **Ctrl-Shift-8** to wrap the selection in an ordered list
// * **Ctrl-Shift-9** to wrap the selection in a bullet list
// * **Ctrl->** to wrap the selection in a block quote
// * **Enter** to split a non-empty textblock in a list item while at
//   the same time splitting the list item
// * **Mod-Enter** to insert a hard break
// * **Mod-_** to insert a horizontal rule
// * **Backspace** to undo an input rule
// * **Alt-ArrowUp** to `joinUp`
// * **Alt-ArrowDown** to `joinDown`
// * **Mod-BracketLeft** to `lift`
// * **Escape** to `selectParentNode`
//
// You can suppress or map these bindings by passing a `mapKeys`
// argument, which maps key names (say `"Mod-B"` to either `false`, to
// remove the binding, or a new key name string.
export function buildKeymap(schema, mapKeys) {
    const keys = {};
    let type;
    function bind(key, cmd) {
        if (mapKeys) {
            const mapped = mapKeys[key];
            if (mapped === false) {
                return;
            }
            if (mapped) {
                key = mapped;
            }
        }
        keys[key] = cmd;
    }
    bind('Mod-z', undo);
    bind('Shift-Mod-z', redo);
    bind('Backspace', undoInputRule);
    if (!mac) {
        bind('Mod-y', redo);
    }
    bind('Alt-ArrowUp', joinUp);
    bind('Alt-ArrowDown', joinDown);
    bind('Mod-BracketLeft', lift);
    bind('Escape', selectParentNode);
    // tslint:disable:no-conditional-assignment
    if ((type = schema.marks.strong)) {
        bind('Mod-b', toggleMark(type));
        bind('Mod-B', toggleMark(type));
    }
    if ((type = schema.marks.em)) {
        bind('Mod-i', toggleMark(type));
        bind('Mod-I', toggleMark(type));
    }
    if ((type = schema.marks.code)) {
        bind('Mod-`', toggleMark(type));
    }
    if ((type = schema.nodes.bullet_list)) {
        bind('Shift-Ctrl-8', wrapInList(type));
    }
    if ((type = schema.nodes.ordered_list)) {
        bind('Shift-Ctrl-9', wrapInList(type));
    }
    if ((type = schema.nodes.blockquote)) {
        bind('Ctrl->', wrapIn(type));
    }
    if ((type = schema.nodes.hard_break)) {
        const br = type;
        const cmd = chainCommands(exitCode, (state, dispatch) => {
            // tslint:disable-next-line:no-non-null-assertion
            dispatch(state.tr.replaceSelectionWith(br.create()).scrollIntoView());
            return true;
        });
        bind('Mod-Enter', cmd);
        bind('Shift-Enter', cmd);
        if (mac) {
            bind('Ctrl-Enter', cmd);
        }
    }
    if ((type = schema.nodes.list_item)) {
        bind('Enter', splitListItem(type));
        bind('Mod-[', liftListItem(type));
        bind('Mod-]', sinkListItem(type));
    }
    if ((type = schema.nodes.paragraph)) {
        bind('Shift-Ctrl-0', setBlockType(type));
    }
    if ((type = schema.nodes.code_block)) {
        bind('Shift-Ctrl-\\', setBlockType(type));
    }
    if ((type = schema.nodes.heading)) {
        for (let i = 1; i <= 6; i++) {
            bind('Shift-Ctrl-' + i, setBlockType(type, { level: i }));
        }
    }
    if ((type = schema.nodes.horizontal_rule)) {
        const hr = type;
        bind('Mod-_', (state, dispatch) => {
            dispatch(state.tr.replaceSelectionWith(hr.create()).scrollIntoView());
            return true;
        });
    }
    return keys;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoia2V5bWFwLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vLi4vc3JjL2xpYi9jb3JlL3NyYy9zaGFyZWQvY29tcG9uZW50cy9yaWNoLXRleHQtZWRpdG9yL3Byb3NlbWlycm9yL2tleW1hcC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQ0gsYUFBYSxFQUNiLFFBQVEsRUFDUixRQUFRLEVBQ1IsTUFBTSxFQUNOLElBQUksRUFDSixnQkFBZ0IsRUFDaEIsWUFBWSxFQUNaLFVBQVUsRUFDVixNQUFNLEdBQ1QsTUFBTSxzQkFBc0IsQ0FBQztBQUM5QixPQUFPLEVBQUUsSUFBSSxFQUFFLElBQUksRUFBRSxNQUFNLHFCQUFxQixDQUFDO0FBQ2pELE9BQU8sRUFBRSxhQUFhLEVBQUUsTUFBTSx3QkFBd0IsQ0FBQztBQUV2RCxPQUFPLEVBQUUsWUFBWSxFQUFFLFlBQVksRUFBRSxhQUFhLEVBQUUsVUFBVSxFQUFFLE1BQU0seUJBQXlCLENBQUM7QUFJaEcsTUFBTSxHQUFHLEdBQUcsT0FBTyxTQUFTLEtBQUssV0FBVyxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDO0FBRXRGLGdDQUFnQztBQUNoQyxnRUFBZ0U7QUFDaEUsZ0VBQWdFO0FBQ2hFLGlCQUFpQjtBQUNqQixFQUFFO0FBQ0YsOERBQThEO0FBQzlELDREQUE0RDtBQUM1RCwrREFBK0Q7QUFDL0Qsa0VBQWtFO0FBQ2xFLHFFQUFxRTtBQUNyRSxtREFBbUQ7QUFDbkQsd0VBQXdFO0FBQ3hFLDhEQUE4RDtBQUM5RCw0REFBNEQ7QUFDNUQsc0RBQXNEO0FBQ3RELHFFQUFxRTtBQUNyRSwwQ0FBMEM7QUFDMUMseUNBQXlDO0FBQ3pDLDBDQUEwQztBQUMxQyx3Q0FBd0M7QUFDeEMsZ0NBQWdDO0FBQ2hDLG9DQUFvQztBQUNwQyxrQ0FBa0M7QUFDbEMscUNB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QUU7WUFDekIsSUFBSSxDQUFDLGFBQWEsR0FBRyxDQUFDLEVBQUUsWUFBWSxDQUFDLElBQUksRUFBRSxFQUFFLEtBQUssRUFBRSxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUM7U0FDN0Q7S0FDSjtJQUNELElBQUksQ0FBQyxJQUFJLEdBQUcsTUFBTSxDQUFDLEtBQUssQ0FBQyxlQUFlLENBQUMsRUFBRTtRQUN2QyxNQUFNLEVBQUUsR0FBRyxJQUFJLENBQUM7UUFDaEIsSUFBSSxDQUFDLE9BQU8sRUFBRSxDQUFDLEtBQUssRUFBRSxRQUFRLEVBQUUsRUFBRTtZQUM5QixRQUFRLENBQUMsS0FBSyxDQUFDLEVBQUUsQ0FBQyxvQkFBb0IsQ0FBQyxFQUFFLENBQUMsTUFBTSxFQUFFLENBQUMsQ0FBQyxjQUFjLEVBQUUsQ0FBQyxDQUFDO1lBQ3RFLE9BQU8sSUFBSSxDQUFDO1FBQ2hCLENBQUMsQ0FBQyxDQUFDO0tBQ047SUFFRCxPQUFPLElBQUksQ0FBQztBQUNoQixDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtcclxuICAgIGNoYWluQ29tbWFuZHMsXHJcbiAgICBleGl0Q29kZSxcclxuICAgIGpvaW5Eb3duLFxyXG4gICAgam9pblVwLFxyXG4gICAgbGlmdCxcclxuICAgIHNlbGVjdFBhcmVudE5vZGUsXHJcbiAgICBzZXRCbG9ja1R5cGUsXHJcbiAgICB0b2dnbGVNYXJrLFxyXG4gICAgd3JhcEluLFxyXG59IGZyb20gJ3Byb3NlbWlycm9yLWNvbW1hbmRzJztcclxuaW1wb3J0IHsgcmVkbywgdW5kbyB9IGZyb20gJ3Byb3NlbWlycm9yLWhpc3RvcnknO1xyXG5pbXBvcnQgeyB1bmRvSW5wdXRSdWxlIH0gZnJvbSAncHJvc2VtaXJyb3ItaW5wdXRydWxlcyc7XHJcbmltcG9ydCB7IE1hcmtUeXBlLCBOb2RlVHlwZSwgU2NoZW1hIH0gZnJvbSAncHJvc2VtaXJyb3ItbW9kZWwnO1xyXG5pbXBvcnQgeyBsaWZ0TGlzdEl0ZW0sIHNpbmtMaXN0SXRlbSwgc3BsaXRMaXN0SXRlbSwgd3JhcEluTGlzdCB9IGZyb20gJ3Byb3NlbWlycm9yLXNjaGVtYS1saXN0JztcclxuXHJcbmltcG9ydCB7IEtleW1hcCB9IGZyb20gJy4vdHlwZXMnO1xyXG5cclxuY29uc3QgbWFjID0gdHlwZW9mIG5hdmlnYXRvciAhPT0gJ3VuZGVmaW5lZCcgPyAvTWFjLy50ZXN0KG5hdmlnYXRvci5wbGF0Zm9ybSkgOiBmYWxzZTtcclxuXHJcbi8vIDo6IChTY2hlbWEsID9PYmplY3QpIOKGkiBPYmplY3RcclxuLy8gSW5zcGVjdCB0aGUgZ2l2ZW4gc2NoZW1hIGxvb2tpbmcgZm9yIG1hcmtzIGFuZCBub2RlcyBmcm9tIHRoZVxyXG4vLyBiYXNpYyBzY2hlbWEsIGFuZCBpZiBmb3VuZCwgYWRkIGtleSBiaW5kaW5ncyByZWxhdGVkIHRvIHRoZW0uXHJcbi8vIFRoaXMgd2lsbCBhZGQ6XHJcbi8vXHJcbi8vICogKipNb2QtYioqIGZvciB0b2dnbGluZyBbc3Ryb25nXSgjc2NoZW1hLWJhc2ljLlN0cm9uZ01hcmspXHJcbi8vICogKipNb2QtaSoqIGZvciB0b2dnbGluZyBbZW1waGFzaXNdKCNzY2hlbWEtYmFzaWMuRW1NYXJrKVxyXG4vLyAqICoqTW9kLWAqKiBmb3IgdG9nZ2xpbmcgW2NvZGUgZm9udF0oI3NjaGVtYS1iYXNpYy5Db2RlTWFyaylcclxuLy8gKiAqKkN0cmwtU2hpZnQtMCoqIGZvciBtYWtpbmcgdGhlIGN1cnJlbnQgdGV4dGJsb2NrIGEgcGFyYWdyYXBoXHJcbi8vICogKipDdHJsLVNoaWZ0LTEqKiB0byAqKkN0cmwtU2hpZnQtRGlnaXQ2KiogZm9yIG1ha2luZyB0aGUgY3VycmVudFxyXG4vLyAgIHRleHRibG9jayBhIGhlYWRpbmcgb2YgdGhlIGNvcnJlc3BvbmRpbmcgbGV2ZWxcclxuLy8gKiAqKkN0cmwtU2hpZnQtQmFja3NsYXNoKiogdG8gbWFrZSB0aGUgY3VycmVudCB0ZXh0YmxvY2sgYSBjb2RlIGJsb2NrXHJcbi8vICogKipDdHJsLVNoaWZ0LTgqKiB0byB3cmFwIHRoZSBzZWxlY3Rpb24gaW4gYW4gb3JkZXJlZCBsaXN0XHJcbi8vICogKipDdHJsLVNoaWZ0LTkqKiB0byB3cmFwIHRoZSBzZWxlY3Rpb24gaW4gYSBidWxsZXQgbGlzdFxyXG4vLyAqICoqQ3RybC0+KiogdG8gd3JhcCB0aGUgc2VsZWN0aW9uIGluIGEgYmxvY2sgcXVvdGVcclxuLy8gKiAqKkVudGVyKiogdG8gc3BsaXQgYSBub24tZW1wdHkgdGV4dGJsb2NrIGluIGEgbGlzdCBpdGVtIHdoaWxlIGF0XHJcbi8vICAgdGhlIHNhbWUgdGltZSBzcGxpdHRpbmcgdGhlIGxpc3QgaXRlbVxyXG4vLyAqICoqTW9kLUVudGVyKiogdG8gaW5zZXJ0IGEgaGFyZCBicmVha1xyXG4vLyAqICoqTW9kLV8qKiB0byBpbnNlcnQgYSBob3Jpem9udGFsIHJ1bGVcclxuLy8gKiAqKkJhY2tzcGFjZSoqIHRvIHVuZG8gYW4gaW5wdXQgcnVsZVxyXG4vLyAqICoqQWx0LUFycm93VXAqKiB0byBgam9pblVwYFxyXG4vLyAqICoqQWx0LUFycm93RG93bioqIHRvIGBqb2luRG93bmBcclxuLy8gKiAqKk1vZC1CcmFja2V0TGVmdCoqIHRvIGBsaWZ0YFxyXG4vLyAqICoqRXNjYXBlKiogdG8gYHNlbGVjdFBhcmVudE5vZGVgXHJcbi8vXHJcbi8vIFlvdSBjYW4gc3VwcHJlc3Mgb3IgbWFwIHRoZXNlIGJpbmRpbmdzIGJ5IHBhc3NpbmcgYSBgbWFwS2V5c2BcclxuLy8gYXJndW1lbnQsIHdoaWNoIG1hcHMga2V5IG5hbWVzIChzYXkgYFwiTW9kLUJcImAgdG8gZWl0aGVyIGBmYWxzZWAsIHRvXHJcbi8vIHJlbW92ZSB0aGUgYmluZGluZywgb3IgYSBuZXcga2V5IG5hbWUgc3RyaW5nLlxyXG5leHBvcnQgZnVuY3Rpb24gYnVpbGRLZXltYXAoc2NoZW1hOiBTY2hlbWEsIG1hcEtleXM/OiBLZXltYXApIHtcclxuICAgIGNvbnN0IGtleXMgPSB7fTtcclxuICAgIGxldCB0eXBlOiBNYXJrVHlwZSB8IE5vZGVUeXBlO1xyXG4gICAgZnVuY3Rpb24gYmluZChrZXk6IHN0cmluZywgY21kOiAoLi4uYXJnczogYW55W10pID0+IGJvb2xlYW4pIHtcclxuICAgICAgICBpZiAobWFwS2V5cykge1xyXG4gICAgICAgICAgICBjb25zdCBtYXBwZWQgPSBtYXBLZXlzW2tleV07XHJcbiAgICAgICAgICAgIGlmIChtYXBwZWQgPT09IGZhbHNlKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgaWYgKG1hcHBlZCkge1xyXG4gICAgICAgICAgICAgICAga2V5ID0gbWFwcGVkO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGtleXNba2V5XSA9IGNtZDtcclxuICAgIH1cclxuXHJcbiAgICBiaW5kKCdNb2QteicsIHVuZG8pO1xyXG4gICAgYmluZCgnU2hpZnQtTW9kLXonLCByZWRvKTtcclxuICAgIGJpbmQoJ0JhY2tzcGFjZScsIHVuZG9JbnB1dFJ1bGUpO1xyXG4gICAgaWYgKCFtYWMpIHtcclxuICAgICAgICBiaW5kKCdNb2QteScsIHJlZG8pO1xyXG4gICAgfVxyXG5cclxuICAgIGJpbmQoJ0FsdC1BcnJvd1VwJywgam9pblVwKTtcclxuICAgIGJpbmQoJ0FsdC1BcnJvd0Rvd24nLCBqb2luRG93bik7XHJcbiAgICBiaW5kKCdNb2QtQnJhY2tldExlZnQnLCBsaWZ0KTtcclxuICAgIGJpbmQoJ0VzY2FwZScsIHNlbGVjdFBhcmVudE5vZGUpO1xyXG5cclxuICAgIC8vIHRzbGludDpkaXNhYmxlOm5vLWNvbmRpdGlvbmFsLWFzc2lnbm1lbnRcclxuICAgIGlmICgodHlwZSA9IHNjaGVtYS5tYXJrcy5zdHJvbmcpKSB7XHJcbiAgICAgICAgYmluZCgnTW9kLWInLCB0b2dnbGVNYXJrKHR5cGUpKTtcclxuICAgICAgICBiaW5kKCdNb2QtQicsIHRvZ2dsZU1hcmsodHlwZSkpO1xyXG4gICAgfVxyXG4gICAgaWYgKCh0eXBlID0gc2NoZW1hLm1hcmtzLmVtKSkge1xyXG4gICAgICAgIGJpbmQoJ01vZC1pJywgdG9nZ2xlTWFyayh0eXBlKSk7XHJcbiAgICAgICAgYmluZCgnTW9kLUknLCB0b2dnbGVNYXJrKHR5cGUpKTtcclxuICAgIH1cclxuICAgIGlmICgodHlwZSA9IHNjaGVtYS5tYXJrcy5jb2RlKSkge1xyXG4gICAgICAgIGJpbmQoJ01vZC1gJywgdG9nZ2xlTWFyayh0eXBlKSk7XHJcbiAgICB9XHJcblxyXG4gICAgaWYgKCh0eXBlID0gc2NoZW1hLm5vZGVzLmJ1bGxldF9saXN0KSkge1xyXG4gICAgICAgIGJpbmQoJ1NoaWZ0LUN0cmwtOCcsIHdyYXBJbkxpc3QodHlwZSkpO1xyXG4gICAgfVxyXG4gICAgaWYgKCh0eXBlID0gc2NoZW1hLm5vZGVzLm9yZGVyZWRfbGlzdCkpIHtcclxuICAgICAgICBiaW5kKCdTaGlmdC1DdHJsLTknLCB3cmFwSW5MaXN0KHR5cGUpKTtcclxuICAgIH1cclxuICAgIGlmICgodHlwZSA9IHNjaGVtYS5ub2Rlcy5ibG9ja3F1b3RlKSkge1xyXG4gICAgICAgIGJpbmQoJ0N0cmwtPicsIHdyYXBJbih0eXBlKSk7XHJcbiAgICB9XHJcbiAgICBpZiAoKHR5cGUgPSBzY2hlbWEubm9kZXMuaGFyZF9icmVhaykpIHtcclxuICAgICAgICBjb25zdCBiciA9IHR5cGU7XHJcbiAgICAgICAgY29uc3QgY21kID0gY2hhaW5Db21tYW5kcyhleGl0Q29kZSwgKHN0YXRlLCBkaXNwYXRjaCkgPT4ge1xyXG4gICAgICAgICAgICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6bm8tbm9uLW51bGwtYXNzZXJ0aW9uXHJcbiAgICAgICAgICAgIGRpc3BhdGNoIShzdGF0ZS50ci5yZXBsYWNlU2VsZWN0aW9uV2l0aChici5jcmVhdGUoKSkuc2Nyb2xsSW50b1ZpZXcoKSk7XHJcbiAgICAgICAgICAgIHJldHVybiB0cnVlO1xyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIGJpbmQoJ01vZC1FbnRlcicsIGNtZCk7XHJcbiAgICAgICAgYmluZCgnU2hpZnQtRW50ZXInLCBjbWQpO1xyXG4gICAgICAgIGlmIChtYWMpIHtcclxuICAgICAgICAgICAgYmluZCgnQ3RybC1FbnRlcicsIGNtZCk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG4gICAgaWYgKCh0eXBlID0gc2NoZW1hLm5vZGVzLmxpc3RfaXRlbSkpIHtcclxuICAgICAgICBiaW5kKCdFbnRlcicsIHNwbGl0TGlzdEl0ZW0odHlwZSkpO1xyXG4gICAgICAgIGJpbmQoJ01vZC1bJywgbGlmdExpc3RJdGVtKHR5cGUpKTtcclxuICAgICAgICBiaW5kKCdNb2QtXScsIHNpbmtMaXN0SXRlbSh0eXBlKSk7XHJcbiAgICB9XHJcbiAgICBpZiAoKHR5cGUgPSBzY2hlbWEubm9kZXMucGFyYWdyYXBoKSkge1xyXG4gICAgICAgIGJpbmQoJ1NoaWZ0LUN0cmwtMCcsIHNldEJsb2NrVHlwZSh0eXBlKSk7XHJcbiAgICB9XHJcbiAgICBpZiAoKHR5cGUgPSBzY2hlbWEubm9kZXMuY29kZV9ibG9jaykpIHtcclxuICAgICAgICBiaW5kKCdTaGlmdC1DdHJsLVxcXFwnLCBzZXRCbG9ja1R5cGUodHlwZSkpO1xyXG4gICAgfVxyXG4gICAgaWYgKCh0eXBlID0gc2NoZW1hLm5vZGVzLmhlYWRpbmcpKSB7XHJcbiAgICAgICAgZm9yIChsZXQgaSA9IDE7IGkgPD0gNjsgaSsrKSB7XHJcbiAgICAgICAgICAgIGJpbmQoJ1NoaWZ0LUN0cmwtJyArIGksIHNldEJsb2NrVHlwZSh0eXBlLCB7IGxldmVsOiBpIH0pKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcbiAgICBpZiAoKHR5cGUgPSBzY2hlbWEubm9kZXMuaG9yaXpvbnRhbF9ydWxlKSkge1xyXG4gICAgICAgIGNvbnN0IGhyID0gdHlwZTtcclxuICAgICAgICBiaW5kKCdNb2QtXycsIChzdGF0ZSwgZGlzcGF0Y2gpID0+IHtcclxuICAgICAgICAgICAgZGlzcGF0Y2goc3RhdGUudHIucmVwbGFjZVNlbGVjdGlvbldpdGgoaHIuY3JlYXRlKCkpLnNjcm9sbEludG9WaWV3KCkpO1xyXG4gICAgICAgICAgICByZXR1cm4gdHJ1ZTtcclxuICAgICAgICB9KTtcclxuICAgIH1cclxuXHJcbiAgICByZXR1cm4ga2V5cztcclxufVxyXG4iXX0=